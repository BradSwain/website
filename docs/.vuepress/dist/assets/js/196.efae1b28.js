(window.webpackJsonp=window.webpackJsonp||[]).push([[196],{245:function(t,e,s){"use strict";s.r(e);var r=s(0),n=Object(r.a)({},function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"content"},[s("h1",{attrs:{id:"_2-million-websockets"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-million-websockets","aria-hidden":"true"}},[t._v("#")]),t._v(" 2 Million WebSockets "),s("seo")],1),t._v(" "),t._m(0),t._v(" "),t._m(1),t._v(" "),t._m(2),t._v(" "),s("img",{attrs:{alt:"Setup diagram",src:"https://raw.githubusercontent.com/lganzzzo/oatpp-website-res/master/diagram/2m-websockets-setup.svg?sanitize=true"}}),t._v(" "),t._m(3),t._v(" "),t._m(4),t._v(" "),t._m(5),t._v(" "),s("p",[t._v("Both server and client applications are running asynchronous oatpp server/client based on "),s("router-link",{attrs:{to:"/docs/oatpp-coroutines/"}},[t._v("oatpp coroutines")]),t._v(".")],1),t._v(" "),t._m(6),t._v(" "),t._m(7),t._v(" "),s("img",{attrs:{alt:"Server monitoring graph",src:"https://github.com/lganzzzo/oatpp-website-res/raw/master/benchmark/websocket/2m/monitoring.png",width:"800px"}}),t._v(" "),t._m(8),t._v(" "),t._m(9),t._v(" "),s("p",[t._v("Server memory consumption was stable at about 15GB.")]),t._v(" "),s("img",{attrs:{alt:"Server resource consumption",border:"1",src:"https://raw.githubusercontent.com/lganzzzo/oatpp-website-res/master/benchmark/websocket/2m/top-server.png",width:"800px"}}),t._v(" "),t._m(10),t._v(" "),t._m(11),t._m(12),t._v(" "),t._m(13),t._v(" "),s("p",[t._v("Client memory consumption was stable at about 10GB.")]),t._v(" "),s("img",{attrs:{alt:"Server resource consumption",border:"1",src:"https://raw.githubusercontent.com/lganzzzo/oatpp-website-res/master/benchmark/websocket/2m/top-client.png",width:"800px"}}),t._v(" "),t._m(14),t._v(" "),t._m(15),t._m(16),t._v(" "),t._m(17),t._v(" "),t._m(18),t._v(" "),t._m(19),t._v(" "),t._m(20),s("ul",[s("li",[t._v("Clone "),s("a",{attrs:{href:"https://github.com/oatpp/benchmark-websocket",target:"_blank",rel:"noopener noreferrer"}},[t._v("benchmark-websocket repo"),s("OutboundLink")],1),t._v(" and "),s("code",[t._v("cd")]),t._v(" to repo folder")])]),t._v(" "),t._m(21),t._m(22),t._v(" "),t._m(23),t._m(24),t._v(" "),t._m(25),t._m(26),t._v(" "),s("p",[t._v("Commands for server instance only:")]),t._v(" "),t._m(27),t._v(" "),t._m(28),t._m(29),t._v(" "),t._m(30),t._m(31),t._v(" "),t._m(32),t._v(" "),s("p",[t._v("Commands for client instance only:")]),t._v(" "),t._m(33),t._v(" "),t._m(34),t._m(35),t._v(" "),t._m(36),t._m(37),t._v(" "),t._m(38),t._v(" "),t._m(39),t._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"https://github.com/oatpp/benchmark-websocket",target:"_blank",rel:"noopener noreferrer"}},[t._v("This benchmark repo"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("router-link",{attrs:{to:"/docs/oatpp-coroutines/"}},[t._v("About oatpp coroutines")])],1),t._v(" "),s("li",[s("a",{attrs:{href:"https://github.com/oatpp/oatpp-websocket",target:"_blank",rel:"noopener noreferrer"}},[t._v("oatpp-websocket repo"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://github.com/oatpp/oatpp",target:"_blank",rel:"noopener noreferrer"}},[t._v("oatpp repo"),s("OutboundLink")],1)])])])},[function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("Date - "),e("code",[this._v("May 5, 2019")]),e("br"),this._v("\nOatpp version - "),e("code",[this._v("0.19.4")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("This article describes oatpp benchmark for 2 Million "),e("strong",[this._v("fully-loaded")]),this._v(" concurrent websocket connections.")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h2",{attrs:{id:"setup"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#setup","aria-hidden":"true"}},[this._v("#")]),this._v(" Setup")])},function(){var t=this.$createElement,e=this._self._c||t;return e("ul",[e("li",[this._v("Server Machine - Google-Cloud "),e("strong",[this._v("n1-highmem-8 (8 vCPUs, 52 GB memory)")]),this._v(" running Debian GNU/Linux 9.")]),this._v(" "),e("li",[this._v("Client Machine - Google-Cloud "),e("strong",[this._v("n1-highmem-8 (8 vCPUs, 52 GB memory)")]),this._v(" running Debian GNU/Linux 9.")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[e("strong",[this._v("Server application")]),this._v(" listens to 100 ports from 8000 to 8099\n(in order to prevent ephemeral ports exhaustion on the client - as we running all 2m clients on the same machine).\nOnce there is a message on WebSocket, server will echo client's message adding "),e("code",[this._v('"Hello from oatpp!"')]),this._v(" at the beginning.")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[e("strong",[this._v("Client application")]),this._v(" opens 20k connections on each port, waits all connections are ready (all WebSocket handshakes are done) then starts the load.\nEach of 2-million websocket clients continuously sends messages to server. Once message is sent client sends another one.")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h2",{attrs:{id:"results"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#results","aria-hidden":"true"}},[this._v("#")]),this._v(" Results")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("Server showed stable performance through all the benchmark test delivering about "),e("code",[this._v("9 Million")]),this._v(" messages per minute ("),e("code",[this._v("~32.7 Mb/Second")]),this._v("):")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h3",{attrs:{id:"server-stats"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#server-stats","aria-hidden":"true"}},[this._v("#")]),this._v(" Server Stats")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h4",{attrs:{id:"resource-consumption"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#resource-consumption","aria-hidden":"true"}},[this._v("#")]),this._v(" Resource consumption")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h4",{attrs:{id:"throughput"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#throughput","aria-hidden":"true"}},[this._v("#")]),this._v(" Throughput")])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[this._v("SOCKETS:          2000000          # - Number of connected clients                                                       \nFRAMES_TOTAL:     2055762317       # - Frames received by server (total)                                                          \nMESSAGES_TOTAL:   2055711187       # - Messages received by server (total)                                                          \nFRAMES_PER_MIN:   9198391.630007   # - Frames received rate per minute                                               \nMESSAGES_PER_MIN: 9194998.122585   # - Messages received rate per minute  \n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("h3",{attrs:{id:"client-stats"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#client-stats","aria-hidden":"true"}},[this._v("#")]),this._v(" Client Stats")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h4",{attrs:{id:"resource-consumption-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#resource-consumption-2","aria-hidden":"true"}},[this._v("#")]),this._v(" Resource consumption")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h4",{attrs:{id:"throughput-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#throughput-2","aria-hidden":"true"}},[this._v("#")]),this._v(" Throughput")])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[this._v("SOCKETS:          2000000          # - Number of connected clients                                                       \nFRAMES_TOTAL:     1986591173       # - Frames received by client (total)                                                          \nMESSAGES_TOTAL:   1986358027       # - Messages received by client (total)                                                          \nFRAMES_PER_MIN:   8971818.390638   # - Frames received rate per minute                                               \nMESSAGES_PER_MIN: 8973755.731700   # - Messages received rate per minute  \n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("h2",{attrs:{id:"steps-to-reproduce"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#steps-to-reproduce","aria-hidden":"true"}},[this._v("#")]),this._v(" Steps to Reproduce")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("Create two "),e("code",[this._v("n1-highmem-8 (8 vCPUs, 52 GB memory) - Debian GNU/Linux 9")]),this._v(" instances in same VPC on Google Cloud.")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h3",{attrs:{id:"execute-the-following-commands-for-both-instances-ssh"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#execute-the-following-commands-for-both-instances-ssh","aria-hidden":"true"}},[this._v("#")]),this._v(" Execute the following commands for both instances (SSH).")])},function(){var t=this.$createElement,e=this._self._c||t;return e("ul",[e("li",[this._v("Install git")])])},function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("$ "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("su")]),t._v("\n$ "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("apt-get")]),t._v(" update\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\n$ "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("apt-get")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" -y "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[this._v("$ "),e("span",{pre:!0,attrs:{class:"token function"}},[this._v("git")]),this._v(" clone https://github.com/oatpp/benchmark-websocket\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[this._v("..")]),this._v(".\n$ "),e("span",{pre:!0,attrs:{class:"token function"}},[this._v("cd")]),this._v(" benchmark-websocket\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("ul",[e("li",[this._v("Install "),e("code",[this._v("oatpp")]),this._v(" and "),e("code",[this._v("oatpp-websocket")]),this._v(" modules (run ./prepare.sh script).")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[this._v("$ ./prepare.sh\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("ul",[e("li",[this._v("Configure environment (run ./sock-config.sh script)")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[this._v("$ ./sock-config.sh\n$ "),e("span",{pre:!0,attrs:{class:"token function"}},[this._v("ulimit")]),this._v(" -n 3000000\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("h3",{attrs:{id:"build-and-run-server"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#build-and-run-server","aria-hidden":"true"}},[this._v("#")]),this._v(" Build and Run Server")])},function(){var t=this.$createElement,e=this._self._c||t;return e("ul",[e("li",[this._v("Build server")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[this._v("$ "),e("span",{pre:!0,attrs:{class:"token function"}},[this._v("cd")]),this._v(" server/build/\n$ cmake "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[this._v("..")]),this._v("\n$ "),e("span",{pre:!0,attrs:{class:"token function"}},[this._v("make")]),this._v("\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("ul",[e("li",[this._v("Run server")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[this._v("$ ./wsb-server-exe --tp 9 --tio 3\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("where:"),e("br"),this._v(" "),e("code",[this._v("--tp")]),this._v(" - number of data-processing threads."),e("br"),this._v(" "),e("code",[this._v("--tio")]),this._v(" - number of I/O workers.")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h3",{attrs:{id:"build-and-run-client"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#build-and-run-client","aria-hidden":"true"}},[this._v("#")]),this._v(" Build and Run Client")])},function(){var t=this.$createElement,e=this._self._c||t;return e("ul",[e("li",[this._v("Build client")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[this._v("$ "),e("span",{pre:!0,attrs:{class:"token function"}},[this._v("cd")]),this._v(" client/build/\n$ cmake "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[this._v("..")]),this._v("\n$ "),e("span",{pre:!0,attrs:{class:"token function"}},[this._v("make")]),this._v("\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("ul",[e("li",[this._v("Run client")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[this._v("$ ./wsb-client-exe --tp 9 --tio 3 -h "),e("span",{pre:!0,attrs:{class:"token operator"}},[this._v("<")]),this._v("server-private-ip"),e("span",{pre:!0,attrs:{class:"token operator"}},[this._v(">")]),this._v(" --socks-max 2000000 --socks-port 20000 --si 1000 --sf 50\n")])])])},function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("p",[t._v("where:"),s("br"),t._v(" "),s("code",[t._v("--tp")]),t._v(" - number of data-processing threads."),s("br"),t._v(" "),s("code",[t._v("--tio")]),t._v(" - number of I/O workers."),s("br"),t._v(" "),s("code",[t._v("-h <server-private-ip>")]),t._v(" - substitute "),s("strong",[t._v("private-ip")]),t._v(" of server instance here."),s("br"),t._v(" "),s("code",[t._v("--socks-max")]),t._v(" - how many client connections to establish."),s("br"),t._v(" "),s("code",[t._v("--socks-port")]),t._v(" - how many client connections per port."),s("br"),t._v(" "),s("code",[t._v("--si 1000 --sf 50")]),t._v(" - control how fast clients will connect to server. Here - each "),s("code",[t._v("1000")]),t._v(" iterations sleep for "),s("code",[t._v("50")]),t._v(" milliseconds.")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[e("strong",[this._v("Note")]),this._v(" - clients will not start load until all clients are connected."),e("br"),this._v(" "),e("strong",[this._v("Note")]),this._v(" - client app will fail with assertion if any of clients has failed.")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h2",{attrs:{id:"links"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#links","aria-hidden":"true"}},[this._v("#")]),this._v(" Links")])}],!1,null,null,null);e.default=n.exports}}]);