<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Benchmark 2-million Websockets | Oat++</title>
    <meta name="description" content="oatpp benchmark for 2 Million fully-loaded concurrent websocket connections.">
    <link rel="icon" href="/logo_x64.png"><link rel='canonical' href='https://oatpp.io/benchmark/websocket/2-million/'/>
    
    <link rel="preload" href="/assets/css/0.styles.49526367.css" as="style"><link rel="preload" href="/assets/js/app.a801b3ee.js" as="script"><link rel="preload" href="/assets/js/151.f9b8e973.js" as="script"><link rel="preload" href="/assets/js/5.6d8ed9c4.js" as="script">
    <link rel="stylesheet" href="/assets/css/0.styles.49526367.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="https://raw.githubusercontent.com/lganzzzo/oatpp-website-res/master/logo_x400.png" alt="Oat++" class="logo"> <span class="site-name can-hide">Oat++</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/benchmark/websocket/5-million/" class="nav-link">Benchmark</a></div><div class="nav-item"><a href="/examples/crud/" class="nav-link">Examples</a></div><div class="nav-item"><a href="/docs/start/" class="nav-link">Docs</a></div><div class="nav-item"><a href="/about/" class="nav-link">About</a></div> <a href="https://github.com/oatpp/oatpp" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/benchmark/websocket/5-million/" class="nav-link">Benchmark</a></div><div class="nav-item"><a href="/examples/crud/" class="nav-link">Examples</a></div><div class="nav-item"><a href="/docs/start/" class="nav-link">Docs</a></div><div class="nav-item"><a href="/about/" class="nav-link">About</a></div> <a href="https://github.com/oatpp/oatpp" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading"><span>About</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>Benchmark</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/benchmark/info/" class="sidebar-link">Info</a></li><li><a href="/benchmark/aws/" class="sidebar-link">Amazon Web Services</a></li><li><a href="/benchmark/digital-ocean/" class="sidebar-link">Digital Ocean</a></li><li><a href="/benchmark/websocket/5-million/" class="sidebar-link">5 Million WebSockets</a></li><li><a href="/benchmark/websocket/2-million/" class="active sidebar-link">2 Million WebSockets</a></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Examples</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Start</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Overview</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Modules</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>API Reference</span> <span class="arrow right"></span></p> <!----></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="_2-million-websockets"><a href="#_2-million-websockets" aria-hidden="true" class="header-anchor">#</a> 2 Million WebSockets <div data-v-4414e9e8></div></h1> <p>Date - <code>May 5, 2019</code><br>
Oatpp version - <code>0.19.4</code></p> <p>This article describes oatpp benchmark for 2 Million <strong>fully-loaded</strong> concurrent websocket connections.</p> <h2 id="setup"><a href="#setup" aria-hidden="true" class="header-anchor">#</a> Setup</h2> <img alt="Setup diagram" src="https://raw.githubusercontent.com/lganzzzo/oatpp-website-res/master/diagram/2m-websockets-setup.svg?sanitize=true"> <ul><li>Server Machine - Google-Cloud <strong>n1-highmem-8 (8 vCPUs, 52 GB memory)</strong> running Debian GNU/Linux 9.</li> <li>Client Machine - Google-Cloud <strong>n1-highmem-8 (8 vCPUs, 52 GB memory)</strong> running Debian GNU/Linux 9.</li></ul> <p><strong>Server application</strong> listens to 100 ports from 8000 to 8099
(in order to prevent ephemeral ports exhaustion on the client - as we running all 2m clients on the same machine).
Once there is a message on WebSocket, server will echo client's message adding <code>&quot;Hello from oatpp!&quot;</code> at the beginning.</p> <p><strong>Client application</strong> opens 20k connections on each port, waits all connections are ready (all WebSocket handshakes are done) then starts the load.
Each of 2-million websocket clients continuously sends messages to server. Once message is sent client sends another one.</p> <p>Both server and client applications are running asynchronous oatpp server/client based on <a href="/docs/oatpp-coroutines/">oatpp coroutines</a>.</p> <h2 id="results"><a href="#results" aria-hidden="true" class="header-anchor">#</a> Results</h2> <p>Server showed stable performance through all the benchmark test delivering about <code>9 Million</code> messages per minute (<code>~32.7 Mb/Second</code>):</p> <img alt="Server monitoring graph" src="https://github.com/lganzzzo/oatpp-website-res/raw/master/benchmark/websocket/2m/monitoring.png" width="800px"> <h3 id="server-stats"><a href="#server-stats" aria-hidden="true" class="header-anchor">#</a> Server Stats</h3> <h4 id="resource-consumption"><a href="#resource-consumption" aria-hidden="true" class="header-anchor">#</a> Resource consumption</h4> <p>Server memory consumption was stable at about 15GB.</p> <img alt="Server resource consumption" border="1" src="https://raw.githubusercontent.com/lganzzzo/oatpp-website-res/master/benchmark/websocket/2m/top-server.png" width="800px"> <h4 id="throughput"><a href="#throughput" aria-hidden="true" class="header-anchor">#</a> Throughput</h4> <div class="language- extra-class"><pre class="language-text"><code>SOCKETS:          2000000          # - Number of connected clients                                                       
FRAMES_TOTAL:     2055762317       # - Frames received by server (total)                                                          
MESSAGES_TOTAL:   2055711187       # - Messages received by server (total)                                                          
FRAMES_PER_MIN:   9198391.630007   # - Frames received rate per minute                                               
MESSAGES_PER_MIN: 9194998.122585   # - Messages received rate per minute  
</code></pre></div><h3 id="client-stats"><a href="#client-stats" aria-hidden="true" class="header-anchor">#</a> Client Stats</h3> <h4 id="resource-consumption-2"><a href="#resource-consumption-2" aria-hidden="true" class="header-anchor">#</a> Resource consumption</h4> <p>Client memory consumption was stable at about 10GB.</p> <img alt="Server resource consumption" border="1" src="https://raw.githubusercontent.com/lganzzzo/oatpp-website-res/master/benchmark/websocket/2m/top-client.png" width="800px"> <h4 id="throughput-2"><a href="#throughput-2" aria-hidden="true" class="header-anchor">#</a> Throughput</h4> <div class="language- extra-class"><pre class="language-text"><code>SOCKETS:          2000000          # - Number of connected clients                                                       
FRAMES_TOTAL:     1986591173       # - Frames received by client (total)                                                          
MESSAGES_TOTAL:   1986358027       # - Messages received by client (total)                                                          
FRAMES_PER_MIN:   8971818.390638   # - Frames received rate per minute                                               
MESSAGES_PER_MIN: 8973755.731700   # - Messages received rate per minute  
</code></pre></div><h2 id="steps-to-reproduce"><a href="#steps-to-reproduce" aria-hidden="true" class="header-anchor">#</a> Steps to Reproduce</h2> <p>Create two <code>n1-highmem-8 (8 vCPUs, 52 GB memory) - Debian GNU/Linux 9</code> instances in same VPC on Google Cloud.</p> <h3 id="execute-the-following-commands-for-both-instances-ssh"><a href="#execute-the-following-commands-for-both-instances-ssh" aria-hidden="true" class="header-anchor">#</a> Execute the following commands for both instances (SSH).</h3> <ul><li>Install git</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">sudo</span> <span class="token function">su</span>
$ <span class="token function">apt-get</span> update
<span class="token punctuation">..</span>.
$ <span class="token function">apt-get</span> <span class="token function">install</span> -y <span class="token function">git</span>
<span class="token punctuation">..</span>.
</code></pre></div><ul><li>Clone <a href="https://github.com/oatpp/benchmark-websocket" target="_blank" rel="noopener noreferrer">benchmark-websocket repo<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> and <code>cd</code> to repo folder</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">git</span> clone https://github.com/oatpp/benchmark-websocket
<span class="token punctuation">..</span>.
$ <span class="token function">cd</span> benchmark-websocket
</code></pre></div><ul><li>Install <code>oatpp</code> and <code>oatpp-websocket</code> modules (run ./prepare.sh script).</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>$ ./prepare.sh
</code></pre></div><ul><li>Configure environment (run ./sock-config.sh script)</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>$ ./sock-config.sh
$ <span class="token function">ulimit</span> -n 3000000
</code></pre></div><h3 id="build-and-run-server"><a href="#build-and-run-server" aria-hidden="true" class="header-anchor">#</a> Build and Run Server</h3> <p>Commands for server instance only:</p> <ul><li>Build server</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">cd</span> server/main/build/
$ cmake <span class="token punctuation">..</span>
$ <span class="token function">make</span>
</code></pre></div><ul><li>Run server</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>$ ./my-project-exe --tp 9 --tio 3
</code></pre></div><p>where:<br> <code>--tp</code> - number of data-processing threads.<br> <code>--tio</code> - number of I/O workers.</p> <h3 id="build-and-run-client"><a href="#build-and-run-client" aria-hidden="true" class="header-anchor">#</a> Build and Run Client</h3> <p>Commands for client instance only:</p> <ul><li>Build client</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">cd</span> client/main/build/
$ cmake <span class="token punctuation">..</span>
$ <span class="token function">make</span>
</code></pre></div><ul><li>Run client</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>$ ./my-project-exe --tp 9 --tio 3 -h <span class="token operator">&lt;</span>server-private-ip<span class="token operator">&gt;</span> --socks-max 2000000 --socks-port 20000 --si 1000 --sf 50
</code></pre></div><p>where:<br> <code>--tp</code> - number of data-processing threads.<br> <code>--tio</code> - number of I/O workers.<br> <code>-h &lt;server-private-ip&gt;</code> - substitute <strong>private-ip</strong> of server instance here.<br> <code>--socks-max</code> - how many client connections to establish.<br> <code>--socks-port</code> - how many client connections per port.<br> <code>--si 1000 --sf 50</code> - control how fast clients will connect to server. Here - each <code>1000</code> iterations sleep for <code>50</code> milliseconds.</p> <p><strong>Note</strong> - clients will not start load until all clients are connected.<br> <strong>Note</strong> - client app will fail with assertion if any of clients has failed.</p> <h2 id="links"><a href="#links" aria-hidden="true" class="header-anchor">#</a> Links</h2> <ul><li><a href="https://github.com/oatpp/benchmark-websocket" target="_blank" rel="noopener noreferrer">This benchmark repo<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="/docs/oatpp-coroutines/">About oatpp coroutines</a></li> <li><a href="https://github.com/oatpp/oatpp-websocket" target="_blank" rel="noopener noreferrer">oatpp-websocket repo<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/oatpp/oatpp" target="_blank" rel="noopener noreferrer">oatpp repo<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/oatpp/website/edit/master/docs/benchmark/websocket/2-million/README.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/benchmark/websocket/5-million/" class="prev">
          5 Million WebSockets
        </a></span> <span class="next"><a href="/examples/crud/">
          CRUD API With Swagger-UI
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/app.a801b3ee.js" defer></script><script src="/assets/js/151.f9b8e973.js" defer></script><script src="/assets/js/5.6d8ed9c4.js" defer></script>
  </body>
</html>
